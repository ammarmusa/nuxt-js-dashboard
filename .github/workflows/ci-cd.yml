# =============================================================================
# CI/CD Pipeline for Nuxt Application
# =============================================================================
# This workflow automates the build, test, and deployment process.
# It runs on every push to main branch and on pull requests targeting main.
# =============================================================================

name: CI/CD Pipeline

# -----------------------------------------------------------------------------
# Trigger Configuration
# -----------------------------------------------------------------------------
# Defines when this workflow should run:
# - On push to main branch: Triggers full pipeline including deployment
# - On pull request to main: Triggers lint, build, and test (no deployment)
# -----------------------------------------------------------------------------
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # ===========================================================================
  # Job 1: Lint and Type Check
  # ===========================================================================
  # Purpose: Ensure code quality and type safety before building
  # This job runs first and blocks other jobs if it fails (except ESLint warnings)
  # ===========================================================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      # -----------------------------------------------------------------------
      # Step 1: Checkout repository
      # Downloads the repository code to the runner so we can work with it
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Step 2: Setup Node.js
      # Installs Node.js v20 and configures npm caching for faster installs
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # -----------------------------------------------------------------------
      # Step 3: Install dependencies
      # Uses 'npm ci' for clean, reproducible installs based on package-lock.json
      # -----------------------------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # -----------------------------------------------------------------------
      # Step 4: Run TypeScript type check
      # Validates all TypeScript types are correct across the codebase
      # -----------------------------------------------------------------------
      - name: Run TypeScript type check
        run: npm run typecheck

      # -----------------------------------------------------------------------
      # Step 5: Run ESLint
      # Checks code style and potential issues. continue-on-error allows
      # warnings without failing the build (errors will still fail)
      # -----------------------------------------------------------------------
      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

  # ===========================================================================
  # Job 2: Build
  # ===========================================================================
  # Purpose: Generate production-ready static files from the Nuxt application
  # Depends on: lint job (waits for lint to complete successfully)
  # ===========================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint # Only runs after lint job succeeds
    steps:
      # -----------------------------------------------------------------------
      # Step 1: Checkout repository
      # Downloads the repository code to the runner
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Step 2: Setup Node.js
      # Installs Node.js v20 with npm caching enabled
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # -----------------------------------------------------------------------
      # Step 3: Install dependencies
      # Clean install of all npm packages
      # -----------------------------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # -----------------------------------------------------------------------
      # Step 4: Generate static site
      # Runs Nuxt's generate command to create static HTML/JS/CSS files
      # Output is placed in .output/public directory
      # -----------------------------------------------------------------------
      - name: Generate static site
        run: npm run generate

      # -----------------------------------------------------------------------
      # Step 5: Upload build artifact
      # Saves the built files as an artifact so the deploy job can access them
      # retention-days: 1 keeps artifacts for 1 day to save storage
      # -----------------------------------------------------------------------
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .output/public
          retention-days: 1

  # ===========================================================================
  # Job 3: Test
  # ===========================================================================
  # Purpose: Run automated tests to catch bugs before deployment
  # Depends on: lint job (runs in parallel with build job after lint succeeds)
  # ===========================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint # Only runs after lint job succeeds
    steps:
      # -----------------------------------------------------------------------
      # Step 1: Checkout repository
      # Downloads the repository code to the runner
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Step 2: Setup Node.js
      # Installs Node.js v20 with npm caching enabled
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # -----------------------------------------------------------------------
      # Step 3: Install dependencies
      # Clean install of all npm packages
      # -----------------------------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # -----------------------------------------------------------------------
      # Step 4: Run tests
      # Executes Vitest test suite to verify application functionality
      # -----------------------------------------------------------------------
      - name: Run tests
        run: npm run test

  # ===========================================================================
  # Job 4: Deploy to Ubuntu Server
  # ===========================================================================
  # Purpose: Deploy the built application to a production Ubuntu server
  # Depends on: build AND test jobs (both must succeed)
  # Condition: Only runs on push to main branch (not on pull requests)
  # ===========================================================================
  deploy:
    name: Deploy to Ubuntu Server
    runs-on: ubuntu-latest
    needs: [build, test] # Waits for both build and test to succeed
    # Only deploy on push to main, not on pull requests
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      # -----------------------------------------------------------------------
      # Step 1: Download build artifact
      # Retrieves the built files from the build job's uploaded artifact
      # Files are downloaded to ./dist directory
      # -----------------------------------------------------------------------
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: ./dist

      # -----------------------------------------------------------------------
      # Step 2: Deploy to server via SSH
      # Securely copies built files to the Ubuntu server using SCP protocol
      # Uses GitHub secrets for sensitive connection details:
      # - SERVER_HOST: Server IP or domain
      # - SERVER_USERNAME: SSH username
      # - SERVER_SSH_KEY: Private SSH key for authentication
      # - SERVER_PORT: SSH port (defaults to 22)
      # - DEPLOY_PATH: Target directory on server
      # strip_components: 1 removes the ./dist prefix when copying
      # -----------------------------------------------------------------------
      - name: Deploy to server via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "./dist/*"
          target: ${{ secrets.DEPLOY_PATH }}
          strip_components: 1

      # -----------------------------------------------------------------------
      # Step 3: Restart PM2 application
      # Executes commands on the server after deployment via SSH
      # Restarts the PM2 process to serve the newly deployed files
      # PM2 handles the Node.js process management for the Nuxt app
      # Nginx reverse proxy forwards requests from internal network to PM2
      # Production port is configured via APP_PORT secret (defaults to 80)
      # -----------------------------------------------------------------------
      - name: Restart PM2 application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "=========================================="
            echo "Starting deployment process..."
            echo "=========================================="

            # Set production port (default to 80 if not specified)
            PROD_PORT="${{ secrets.APP_PORT || 80 }}"

            # Navigate to the deployment directory
            cd ${{ secrets.DEPLOY_PATH }}

            # Stop existing PM2 process if running
            if pm2 describe nuxt-app > /dev/null 2>&1; then
              echo "Stopping existing PM2 process..."
              pm2 delete nuxt-app
            fi

            echo "Starting PM2 process on production port ${PROD_PORT}..."
            # Start serving static files with PM2 using serve
            # -s: Single page application mode (rewrites all routes to index.html)
            # -l: Listen on specified port
            pm2 start serve --name "nuxt-app" -- -s . -l ${PROD_PORT}

            # Save PM2 process list for auto-restart on server reboot
            pm2 save

            echo "=========================================="
            echo "Deployment completed successfully!"
            echo "App is running on port ${PROD_PORT}"
            echo "==========================================""
